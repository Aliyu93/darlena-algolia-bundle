(()=>{var B=Object.defineProperty,q=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var x=(c,t,e)=>t in c?B(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e,A=(c,t)=>{for(var e in t||(t={}))F.call(t,e)&&x(c,e,t[e]);if(P)for(var e of P(t))R.call(t,e)&&x(c,e,t[e]);return c},L=(c,t)=>q(c,k(t));var b=class{constructor(){this.baseUrl="https://me-central2-gtm-5v2mhn4-mwvlm.cloudfunctions.net/function-2",this.maxRetries=2,this.headers={Accept:"application/json","Cache-Control":"public, max-age=3600"},this.cache=new Map,this.fallbackEnabled=!0}async getProducts(t,e,r=0,i=12){var h,g,p;if(!e)return null;let s=`${t}:${e}:${r}:${i}`;if(this.cache.has(s))return this.cache.get(s);let o=t==="category"?"catID":"tagID",n=t==="category"?"categoryById":"tagById",a=`${this.baseUrl}/?type=${n}&${o}=${encodeURIComponent(e)}&offset=${r}&limit=${i}`,l=null;try{let u=new AbortController,m=setTimeout(()=>u.abort(),2e3),w=await fetch(a,{method:"GET",headers:this.headers,signal:u.signal});if(clearTimeout(m),!w.ok)throw new Error(`HTTP error: ${w.status}`);if(l=await w.json(),(h=l==null?void 0:l.objectIDs)!=null&&h.length)return this.cache.set(s,l),l}catch(u){}if(!((g=l==null?void 0:l.objectIDs)!=null&&g.length)&&this.fallbackEnabled)try{let u=await fetch(a,{method:"GET",headers:this.headers});if(u.ok&&(l=await u.json(),(p=l==null?void 0:l.objectIDs)!=null&&p.length))return this.cache.set(s,l),l}catch(u){}return l||{objectIDs:[],hasMore:!1}}async getRecommendations(t){if(!t)return[];let e=`recommendations:${t}`;if(this.cache.has(e))return this.cache.get(e);let r=`${this.baseUrl}/?type=recommendations&objectID=${encodeURIComponent(t)}`;try{let i=new AbortController,s=setTimeout(()=>i.abort(),3e3),o=await fetch(r,{method:"GET",headers:this.headers,signal:i.signal});if(clearTimeout(s),!o.ok)return[];let n=await o.json(),a=Array.isArray(n==null?void 0:n.relatedProductIDs)?n.relatedProductIDs:[];return this.cache.set(e,a),a}catch(i){return[]}}async getFrequentlyBought(t){if(!t)return[];let e=`frequently-bought:${t}`;if(this.cache.has(e))return this.cache.get(e);let r=`${this.baseUrl}/?type=frequentlyBought&objectID=${encodeURIComponent(t)}`;try{let i=new AbortController,s=setTimeout(()=>i.abort(),3e3),o=await fetch(r,{method:"GET",headers:this.headers,signal:i.signal});if(clearTimeout(s),!o.ok)return[];let n=await o.json(),a=Array.isArray(n==null?void 0:n.frequentlyBoughtIDs)?n.frequentlyBoughtIDs:[];return this.cache.set(e,a),a}catch(i){return[]}}async getCategoriesFromRedis(){let t="all-categories";if(this.cache.has(t))return this.cache.get(t);try{let e=new AbortController,r=setTimeout(()=>e.abort(),5e3),i=await fetch(`${this.baseUrl}/?type=categories`,{method:"GET",headers:this.headers,signal:e.signal});if(clearTimeout(r),!i.ok)return[];let o=(await i.json()).categories||[];return this.cache.set(t,o),o}catch(e){return[]}}async getGlobalProducts(t=0,e=12){let r=`global-products:${t}:${e}`;if(this.cache.has(r))return this.cache.get(r);try{let i=new AbortController,s=setTimeout(()=>i.abort(),3e3),o=`${this.baseUrl}/?type=categoryById&catID=trending-now&offset=${t}&limit=${e}`,n=await fetch(o,{method:"GET",headers:this.headers,signal:i.signal});if(clearTimeout(s),!n.ok)return{objectIDs:[],hasMore:!1};let a=await n.json(),l={objectIDs:a.objectIDs||[],hasMore:a.hasMore||!1};return this.cache.set(r,l),l}catch(i){return{objectIDs:[],hasMore:!1}}}async getCategoryPageById(t,e=0,r=12){return this.getProducts("category",t,e,r)}async getCategoryProducts(t,e,r){return this.getProducts("category",t,e,r)}async getTagProducts(t,e,r){return this.getProducts("tag",t,e,r)}},d=new b;var S=class extends HTMLElement{constructor(){super(),this.initialized=!1,this.productIds=[]}connectedCallback(){this.initialized||this.getHighestValueItemFromDOM().then(t=>t?this.fetchFrequentlyBoughtProducts(t):[]).then(()=>{this.renderProductList(),setTimeout(()=>{this.initializeSlider()},1e3)}).catch(t=>{console.error("[CartAddonsSlider] Error loading products:",t)})}async getHighestValueItemFromDOM(){try{let t=document.querySelectorAll('form[id^="item-"]');if(!t||t.length===0)return console.log("[CartAddonsSlider] No cart items found in DOM"),null;let e=null,r=0;return t.forEach(i=>{try{let s=i.getAttribute("id")||"",o=s.replace("item-",""),n=i.querySelector('a[href*="/p"]');if(!n){console.log("[CartAddonsSlider] No product link found in form",s);return}let a=n.getAttribute("href"),l=a.match(/\/p(\d+)(?:$|\/|\?)/);if(!l||!l[1]){console.log("[CartAddonsSlider] Could not extract product ID from URL",a);return}let h=l[1],g=i.querySelector(".item-total");if(g){let u=(g.textContent||g.innerText||"0").replace(/[^\d.,٠١٢٣٤٥٦٧٨٩]/g,"").replace(/٠/g,"0").replace(/١/g,"1").replace(/٢/g,"2").replace(/٣/g,"3").replace(/٤/g,"4").replace(/٥/g,"5").replace(/٦/g,"6").replace(/٧/g,"7").replace(/٨/g,"8").replace(/٩/g,"9"),m=parseFloat(u.replace(",","."))||0;console.log(`[CartAddonsSlider] Item ${o}: Product ID ${h}, Total: ${m}`),!isNaN(m)&&m>r&&(r=m,e={itemId:o,productId:h,total:m})}}catch(s){console.error("[CartAddonsSlider] Error processing item form:",s)}}),e?(console.log("[CartAddonsSlider] Highest value item:",e),e.productId):null}catch(t){return console.error("[CartAddonsSlider] Error extracting cart data from DOM:",t),null}}async fetchFrequentlyBoughtProducts(t){try{console.log("[CartAddonsSlider] Fetching frequently bought products for:",t);let e=await d.getFrequentlyBought(t);return e&&e.length>0?(console.log("[CartAddonsSlider] Found frequently bought products:",e),this.productIds=e.map(r=>String(r)).slice(0,8),this.productIds):(console.log("[CartAddonsSlider] No frequently bought products found"),this.productIds=[],[])}catch(e){return console.error("[CartAddonsSlider] Error fetching frequently bought products:",e),this.productIds=[],[]}}renderProductList(){if(!this.productIds||this.productIds.length===0){console.log("[CartAddonsSlider] No products to render, hiding component"),this.style.display="none";return}console.log("[CartAddonsSlider] Rendering product list with IDs:",this.productIds);let t=this.querySelector(".frequently-bought-container");if(!t){console.error("[CartAddonsSlider] Container not found");return}let e=document.createElement("salla-products-list");e.setAttribute("source","selected"),e.setAttribute("loading","lazy"),e.setAttribute("source-value",JSON.stringify(this.productIds)),e.setAttribute("class","s-products-list-vertical-cards"),t.innerHTML="",t.appendChild(e);let r=document.createElement("div");r.classList.add("touch-indicator"),this.appendChild(r),console.log("[CartAddonsSlider] Product list rendered")}initializeSlider(){var t,e;try{let r=this.querySelector("salla-products-list");if(!r){console.log("[CartAddonsSlider] Products list not found");return}r.style.opacity="1",(e=(t=window.salla)==null?void 0:t.event)!=null&&e.dispatch&&window.salla.event.dispatch("twilight::mutation"),this.initialized=!0,console.log("[CartAddonsSlider] Slider initialized")}catch(r){console.error("[CartAddonsSlider] Failed to initialize cart addons slider:",r)}}};customElements.get("cart-addons-slider")||(customElements.define("cart-addons-slider",S),console.log("[CartAddonsSlider] Custom element defined"));var I=class extends HTMLElement{constructor(){super(),this.page=0,this.loading=!1,this.hasMore=!0,this.ids=[],this.container=null,this.originalList=null,this.usingSallaFilter=!1,this.timeout=null}async connectedCallback(){let t=this.getAttribute("category-id"),e=this.getAttribute("tag-id");if(!(!t&&!e))try{await this.waitForSalla(),this.setupFilterListener(),await this.initialize(t,e)}catch(r){this.restoreOriginalList()}}restoreOriginalList(){var r,i;if(!this.originalList||this.usingSallaFilter)return;let t=document.querySelector(".ranked-products, salla-products-list[filter]"),e=(t==null?void 0:t.parentNode)||this.originalList.parentNode;t&&t.remove(),this.container&&(this.container.remove(),this.container=null),e&&!e.querySelector("salla-products-list")&&(e.appendChild(this.originalList.cloneNode(!0)),(i=(r=window.salla)==null?void 0:r.event)==null||i.dispatch("twilight::mutation"))}setupFilterListener(){document.addEventListener("change",t=>{if(t.target.id!=="product-filter")return;let e=t.target.value;e==="ourSuggest"&&this.usingSallaFilter?this.applyRedisRanking():e!=="ourSuggest"&&this.applySallaFilter(e)})}async applySallaFilter(t){var n,a,l;let e=this.getAttribute("category-id"),r=this.getAttribute("tag-id");if(!this.originalList)return;let i=document.querySelector(".ranked-products, salla-products-list[filter]"),s=(i==null?void 0:i.parentNode)||((n=this.container)==null?void 0:n.parentNode);if(!s)return;i&&i.remove(),this.container&&(this.container.remove(),this.container=null),this.cleanupScrollListener(),this.usingSallaFilter=!0;let o=this.originalList.cloneNode(!0);o.setAttribute("filter",t),s.appendChild(o),(l=(a=window.salla)==null?void 0:a.event)==null||l.dispatch("twilight::mutation")}async applyRedisRanking(){let t=this.getAttribute("category-id"),e=this.getAttribute("tag-id");this.usingSallaFilter=!1,await this.initialize(t,e,!0)}async initialize(t,e,r=!1){var g,p,u;if(this.container&&!this.usingSallaFilter&&!r)return;let i=t?'salla-products-list[source="product.index"], salla-products-list[source="categories"]':'salla-products-list[source="product.index.tag"], salla-products-list[source^="tags."]',s=document.querySelector(i);if(!s)return;this.originalList||(this.originalList=s.cloneNode(!0));let o=document.getElementById("product-filter");if(o)o.value="ourSuggest",this.usingSallaFilter=!1;else if(o&&o.value!=="ourSuggest"&&!r){this.usingSallaFilter=!0;return}let n=t?d.getCategoryProducts(t,0,12):d.getTagProducts(e,0,12),a=s.parentNode;this.container=document.createElement("div"),this.container.className="ranked-products",a.insertBefore(this.container,s),clearTimeout(this.timeout),this.timeout=setTimeout(()=>{(!this.ids||!this.ids.length)&&this.restoreOriginalList()},2500);let l=await n;if(clearTimeout(this.timeout),!((g=l==null?void 0:l.objectIDs)!=null&&g.length)){this.restoreOriginalList();return}this.ids=l.objectIDs,this.page=0,this.hasMore=!0,this.usingSallaFilter=!1;let h=document.createElement("salla-products-list");h.setAttribute("source","selected"),h.setAttribute("source-value",JSON.stringify(this.ids)),h.setAttribute("limit",this.ids.length),h.className=s.className||"w-full",this.container.appendChild(h),s.remove(),(u=(p=window.salla)==null?void 0:p.event)==null||u.dispatch("twilight::mutation"),this.setupScrollListener()}setupScrollListener(){this.cleanupScrollListener(),this._boundScrollHandler=this.handleScroll.bind(this),window.addEventListener("scroll",this._boundScrollHandler)}cleanupScrollListener(){this._boundScrollHandler&&(window.removeEventListener("scroll",this._boundScrollHandler),this._boundScrollHandler=null)}handleScroll(){if(this.loading||!this.hasMore||this.usingSallaFilter)return;let t=window.scrollY+window.innerHeight,e=document.documentElement.scrollHeight*.5;t>e&&this.loadMore()}async loadMore(){var t,e,r;if(!(this.loading||!this.hasMore)){this.loading=!0;try{let i=this.page+1,s=i*12,o=this.getAttribute("category-id"),n=this.getAttribute("tag-id"),a=o?await d.getCategoryProducts(o,s,12):await d.getTagProducts(n,s,12);if(!((t=a==null?void 0:a.objectIDs)!=null&&t.length)){this.hasMore=!1;return}let l=document.createElement("salla-products-list");l.setAttribute("source","selected"),l.setAttribute("source-value",JSON.stringify(a.objectIDs)),l.setAttribute("limit",a.objectIDs.length),l.className="w-full",this.container.appendChild(l),this.page=i,this.hasMore=a.hasMore!==!1,(r=(e=window.salla)==null?void 0:e.event)==null||r.dispatch("twilight::mutation")}catch(i){this.hasMore=!1}finally{this.loading=!1}}}async waitForSalla(){if(!window.salla)return new Promise(t=>{document.addEventListener("salla::ready",t,{once:!0}),setTimeout(t,3e3)})}disconnectedCallback(){this.cleanupScrollListener(),clearTimeout(this.timeout)}};customElements.get("product-ranking")||customElements.define("product-ranking",I);var C=class extends HTMLElement{constructor(){super(),this.state={productsPerPage:30,categories:[],trendingCategory:{name:"\u0631\u0627\u0626\u062C \u0627\u0644\u0627\u0646",slug:"trending-now",filter:null,hasSubcats:!1,url:null}},this.categoriesLoading=!0,this.seenProductIds=new Set,this.innerHTML=`
            <div class="category-filter">
                <div class="categories-loading">\u062C\u0627\u0631\u0650 \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0641\u0626\u0627\u062A...</div>
            </div>
        `}async connectedCallback(){try{await this.fetchCategoriesFromCloudRun();let t=this.createTemplate();this.innerHTML=t,await this.initializeCategorySections()}catch(t){this.handleInitError(t)}}disconnectedCallback(){}async fetchCategoriesFromCloudRun(){let t={228327271:{name:"\u062C\u0645\u064A\u0639 \u0627\u0644\u0639\u0628\u0627\u064A\u0627\u062A",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA/c228327271"},476899183:{name:"\u062C\u0644\u0627\u0628\u064A\u0627\u062A",url:"https://darlena.com/%D8%AC%D9%84%D8%A7%D8%A8%D9%8A%D8%A7%D8%AA/c476899183"},1466412179:{name:"\u062C\u062F\u064A\u062F\u0646\u0627",url:"https://darlena.com/%D8%AC%D8%AF%D9%8A%D8%AF-%D8%AF%D8%A7%D8%B1-%D9%84%D9%8A%D9%86%D8%A7/c1466412179"},289250285:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0643\u0644\u0648\u0634",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D9%83%D9%84%D9%88%D8%B4/c289250285"},1891285357:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0633\u0648\u062F\u0627\u0621 \u0633\u0627\u062F\u0629",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D8%B3%D9%88%D8%AF%D8%A7%D8%A1-%D8%B3%D8%A7%D8%AF%D8%A9/c1891285357"},2132455494:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0645\u0644\u0648\u0646\u0629",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D9%85%D9%84%D9%88%D9%86%D8%A9/c2132455494"},940975465:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0628\u062C\u064A\u0648\u0628",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D8%A8%D8%AC%D9%8A%D9%88%D8%A8/c940975465"},1567146102:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0628\u0634\u062A",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D8%A8%D8%B4%D8%AA/c1567146102"},832995956:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0645\u0637\u0631\u0632\u0629",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D9%85%D8%B7%D8%B1%D8%B2%D8%A9/c832995956"},2031226480:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0631\u0623\u0633",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D8%B1%D8%A3%D8%B3/c2031226480"},1122348775:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0635\u064A\u0641\u064A\u0629",url:"https://darlena.com/%D8%B9%D8%A8%D8%A7%D9%8A%D8%A7%D8%AA-%D8%B5%D9%8A%D9%81%D9%8A%D8%A9/c1122348775"},692927841:{name:"\u0637\u0631\u062D",url:"https://darlena.com/%D8%B7%D8%B1%D8%AD/c692927841"},639447590:{name:"\u0646\u0642\u0627\u0628\u0627\u062A",url:"https://darlena.com/%D9%86%D9%82%D8%A7%D8%A8%D8%A7%D8%AA/c639447590"},114756598:{name:"\u0639\u0628\u0627\u064A\u0627\u062A \u0634\u064A\u0641\u0648\u0646",url:"https://darlena.com/%D8%B4%D9%8A%D9%81%D9%88%D9%86/c114756598"}},e={"\u0631\u0627\u0626\u062C \u0627\u0644\u0627\u0646":1,\u062C\u062F\u064A\u062F\u0646\u0627:2,"\u0639\u0628\u0627\u064A\u0627\u062A \u0635\u064A\u0641\u064A\u0629":3,"\u062C\u0645\u064A\u0639 \u0627\u0644\u0639\u0628\u0627\u064A\u0627\u062A":4,"\u0639\u0628\u0627\u064A\u0627\u062A \u0643\u0644\u0648\u0634":5,\u062C\u0644\u0627\u0628\u064A\u0627\u062A:6,"\u0639\u0628\u0627\u064A\u0627\u062A \u0634\u064A\u0641\u0648\u0646":7,"\u0639\u0628\u0627\u064A\u0627\u062A \u0633\u0648\u062F\u0627\u0621 \u0633\u0627\u062F\u0629":8,"\u0639\u0628\u0627\u064A\u0627\u062A \u0628\u062C\u064A\u0648\u0628":9,"\u0639\u0628\u0627\u064A\u0627\u062A \u0628\u0634\u062A":10,"\u0639\u0628\u0627\u064A\u0627\u062A \u0645\u0637\u0631\u0632\u0629":11,"\u0639\u0628\u0627\u064A\u0627\u062A \u0631\u0623\u0633":12,"\u0639\u0628\u0627\u064A\u0627\u062A \u0645\u0644\u0648\u0646\u0629":13,\u0637\u0631\u062D:14,\u0646\u0642\u0627\u0628\u0627\u062A:15};try{let r=await d.getCategoriesFromRedis();if(!Array.isArray(r))throw new Error("Categories data is not an array");let i=r.map(s=>({slug:s.name,name:s.name,filter:s.name,hasSubcats:!1,count:s.count||0,ids:s.ids||(s.id?[s.id]:[])}));i=i.filter(s=>{if(s.ids.length>0){let o=Number(s.ids[0]);return t.hasOwnProperty(o)}return!1}).map(s=>{let o=Number(s.ids[0]);return L(A({},s),{name:t[o].name,slug:t[o].name.toLowerCase().replace(/\s+/g,"-"),url:t[o].url,ids:s.ids})}),i.sort((s,o)=>{let n=e[s.name]||999,a=e[o.name]||999;return n-a}),i.unshift(A({},this.state.trendingCategory)),this.state.categories=i}catch(r){throw this.state.categories=[A({},this.state.trendingCategory)],r}finally{this.categoriesLoading=!1}}createTemplate(){return this.categoriesLoading?`
                <div class="category-filter">
                    <div class="categories-loading">\u062C\u0627\u0631\u0650 \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0641\u0626\u0627\u062A...</div>
                </div>
            `:`
            <style>
                .category-filter {
                    max-width: 1280px;
                    margin: 0 auto;
                    margin-top: 4rem;
                    padding: 0;
                }
                .category-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1.5rem;
                    position: relative;
                    padding-bottom: 0.5rem;
                }
                .category-header:after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 1px;
                    background-color: rgba(212, 172, 132, 0.1);
                }
                .category-title {
                    font-size: 1.25rem;
                    font-weight: 600;
                    color: #d4ac84;
                    order: -1;
                    padding-right: 1rem;
                }
                .view-all {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    font-size: 0.875rem;
                    color: #d4ac84;
                    text-decoration: none;
                }
                .view-all i {
                    font-size: 0.75rem;
                }
                .view-all i:first-child {
                    order: 1;
                }
                .view-all i:last-child {
                    order: -1;
                }
                .category-section {
                    margin-bottom: 2rem;
                }
                salla-products-slider {
                    --slider-arrows-display: block !important;
                    --slider-arrows-rtl: 1;
                }
                .s-product-card-sale-price {
                    font-size: 0.75rem;
                    display: inline-flex;
                    gap: 0.4rem;
                    align-items: center;
                    white-space: nowrap;
                    overflow: hidden;
                }
                .s-product-card-sale-price h4,
                .s-product-card-sale-price span {
                    white-space: nowrap;
                    display: inline-block;
                }
                @media (max-width: 768px) {
                    salla-products-slider .swiper-slide {
                        width: 50% !important;
                    }
                }
                @media (min-width: 769px) and (max-width: 1024px) {
                    salla-products-slider .swiper-slide {
                        width: 33.333% !important;
                    }
                }
                @media (min-width: 1025px) {
                    salla-products-slider .swiper-slide {
                        width: 25% !important;
                    }
                }
            </style>
            <div class="category-filter">
                ${this.state.categories.map(e=>`
                    <div class="category-section" data-category="${e.slug}">
                        <div class="category-header">
                            ${e.url?`<a href="${e.url}" class="view-all">
                                     <i class="sicon-keyboard_arrow_left"></i>
                                     \u0645\u0634\u0627\u0647\u062F\u0629 \u0627\u0644\u0643\u0644
                                     <i class="sicon-keyboard_arrow_right"></i>
                                   </a>`:""}
                            <h2 class="category-title">${e.name}</h2>
                        </div>
                        <div id="products-${e.slug}">
                            <div class="slider-loading" style="text-align: center; padding: 1rem;">\u062C\u0627\u0631 \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0645\u0646\u062A\u062C\u0627\u062A...</div>
                        </div>
                    </div>
                `).join("")}
            </div>
        `}async initializeCategorySections(){try{let t=this.state.categories.map(s=>s.slug==="trending-now"?d.getGlobalProducts(0,this.state.productsPerPage).then(o=>({slug:s.slug,ids:o.objectIDs||[]})).catch(o=>({slug:s.slug,ids:[],error:o})):s.ids&&s.ids.length>0?this.fetchRegularCategory(s).then(o=>({slug:s.slug,ids:o||[]})).catch(o=>({slug:s.slug,ids:[],error:o})):Promise.resolve({slug:s.slug,ids:[]})),r=(await Promise.all(t)).reduce((s,o)=>(s[o.slug]=o.ids,s),{});this.seenProductIds.clear();let i={};for(let s of this.state.categories){let o=r[s.slug]||[],n=[];for(let a of o)if(!this.seenProductIds.has(a)&&(this.seenProductIds.add(a),n.push(a),n.length>=6))break;i[s.slug]=n}this.renderProductSliders(i)}catch(t){this.handleInitError(t)}}async fetchRegularCategory(t){let e=t.ids.map(r=>d.getCategoryPageById(r,0,this.state.productsPerPage).catch(i=>({objectIDs:[]})));try{return(await Promise.all(e)).flatMap(i=>i&&i.objectIDs?i.objectIDs:[])}catch(r){return[]}}renderProductSliders(t){this.state.categories.forEach(e=>{let r=e.slug,i=t[r]||[],s=this.querySelector(`#products-${r}`);if(s)if(s.innerHTML="",i.length>0){let o=document.createElement("salla-products-slider");o.setAttribute("source","selected"),o.setAttribute("source-value",JSON.stringify(i)),o.setAttribute("limit",String(i.length)),o.setAttribute("slider-id",`slider-${r}`),o.setAttribute("block-title"," "),o.setAttribute("arrows","true"),o.setAttribute("rtl","true"),s.appendChild(o),setTimeout(()=>{o.querySelectorAll(".s-product-card-content-sub").forEach(a=>{a.children.length>1&&(a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.flexWrap="nowrap",a.style.width="100%",a.style.overflow="visible")})},500)}else s.innerHTML='<div style="text-align: center; padding: 1rem;">\u0644\u0627 \u062A\u0648\u062C\u062F \u0645\u0646\u062A\u062C\u0627\u062A \u0644\u0639\u0631\u0636\u0647\u0627 \u0641\u064A \u0647\u0630\u0647 \u0627\u0644\u0641\u0626\u0629.</div>'})}handleInitError(t){this.innerHTML=`
            <div class="category-filter">
                <div class="error-message" style="color: #e53e3e; text-align: center; padding: 2rem; margin-top: 2rem;">
                    \u0639\u0630\u0631\u0627\u064B\u060C \u062D\u062F\u062B \u062E\u0637\u0623 \u0623\u062B\u0646\u0627\u0621 \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0641\u0626\u0627\u062A. \u064A\u0631\u062C\u0649 \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0635\u0641\u062D\u0629.
                    ${t?"<br><small>Error details logged.</small>":""}
                </div>
            </div>
        `}};customElements.get("mahaba-category-products")||customElements.define("mahaba-category-products",C);var v=class{constructor(){this.initialized=!1,this.productId=null,this.recentlyViewedKey="recently_viewed_products",this.maxRecentProducts=15}initialize(){if(this.initialized||!this.isProductPage()||(this.productId=this.getProductId(),!this.productId))return;this.initialized=!0,this.addToRecentlyViewed(this.productId);let t=()=>{this.loadRecommendations(),this.loadRecentlyViewed()};document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}loadRecommendations(){let t=document.querySelector('salla-products-slider[source="related"]');t?this.replaceRelatedProducts(t):this.waitForElement('salla-products-slider[source="related"]',e=>{this.replaceRelatedProducts(e)})}loadRecentlyViewed(){var n,a;let t=this.getRecentlyViewed();if(!t.length)return;let e=t.map(l=>parseInt(l,10)).filter(l=>l&&!isNaN(l)&&l!==parseInt(this.productId,10));if(!e.length)return;let r=document.createElement("div");r.className="mt-8 s-products-slider-container";let i=document.createElement("h2");i.className="section-title mb-5 font-bold text-xl",i.textContent="\u0627\u0644\u0645\u0646\u062A\u062C\u0627\u062A \u0627\u0644\u0645\u0634\u0627\u0647\u062F\u0629 \u0645\u0624\u062E\u0631\u0627\u064B",r.appendChild(i);let s=document.createElement("salla-products-slider");s.setAttribute("source","selected"),s.setAttribute("source-value",JSON.stringify(e)),s.setAttribute("autoplay","false"),s.setAttribute("class","product-recommendations-slider");let o=document.querySelector('salla-products-slider[source="related"], salla-products-slider[source="selected"]');s.setAttribute("display-style",(o==null?void 0:o.getAttribute("display-style"))||"normal"),r.appendChild(s),this.insertRecentlyViewedSection(r,o),(a=(n=window.salla)==null?void 0:n.event)==null||a.dispatch("twilight::mutation"),this.setupStockFilter(s)}insertRecentlyViewedSection(t,e){let r=document.querySelector(".product-details, .product-entry, #product-entry");if(r&&r.parentNode)return r.parentNode.insertBefore(t,r.nextSibling),!0;if(e){let s=e.closest(".s-products-slider-container");if(s&&s.parentNode)return s.parentNode.insertBefore(t,s.nextSibling),!0;if(e.parentNode)return e.parentNode.insertBefore(t,e.nextSibling),!0}let i=document.querySelector("main, .s-product-page-content, #content, .s-product-page");return i?(i.appendChild(t),!0):(document.body.appendChild(t),!0)}addToRecentlyViewed(t){if(t)try{let e=parseInt(t,10);if(isNaN(e))return;let r=this.getRecentlyViewed();r=r.map(i=>parseInt(i,10)).filter(i=>!isNaN(i)),r=r.filter(i=>i!==e),r.unshift(e),r.length>this.maxRecentProducts&&(r=r.slice(0,this.maxRecentProducts)),sessionStorage.setItem(this.recentlyViewedKey,JSON.stringify(r))}catch(e){}}getRecentlyViewed(){try{let t=sessionStorage.getItem(this.recentlyViewedKey);return t?JSON.parse(t):[]}catch(t){return[]}}isProductPage(){return!!document.querySelector('[id^="product-"], .sidebar .details-slider')}getProductId(){let t=document.querySelector('[id^="product-"]');if(t){let r=t.id.replace("product-",""),i=parseInt(r,10);if(!isNaN(i))return i}let e=window.location.pathname.match(/\/p(\d+)/);if(e!=null&&e[1]){let r=parseInt(e[1],10);if(!isNaN(r))return r}return null}async replaceRelatedProducts(t){var e,r;try{let i=await d.getRecommendations(this.productId);if(!(i!=null&&i.length))return;let s=i.map(n=>parseInt(n,10)).filter(n=>n&&!isNaN(n));if(!s.length)return;let o=document.createElement("salla-products-slider");if(Array.from(t.attributes).forEach(n=>{n.name!=="source-value"&&o.setAttribute(n.name,n.value)}),o.setAttribute("source","selected"),o.setAttribute("source-value",JSON.stringify(s)),o.setAttribute("class","product-recommendations-slider"),t.parentNode.replaceChild(o,t),!document.getElementById("product-recommendations-styles")){let n=document.createElement("style");n.id="product-recommendations-styles",n.textContent=`
                    .product-recommendations-slider .swiper-slide,
                    salla-products-slider[source="selected"] .swiper-slide {
                        width: 47% !important;
                    }
                    @media (min-width: 769px) {
                        .product-recommendations-slider .swiper-slide,
                        salla-products-slider[source="selected"] .swiper-slide {
                            width: 31% !important;
                        }
                    }
                    @media (min-width: 1025px) {
                        .product-recommendations-slider .swiper-slide,
                        salla-products-slider[source="selected"] .swiper-slide {
                            width: 24% !important;
                        }
                    }
                `,document.head.appendChild(n)}(r=(e=window.salla)==null?void 0:e.event)==null||r.dispatch("twilight::mutation"),this.setupStockFilter(o)}catch(i){}}setupStockFilter(t){var e,r;(r=(e=window.salla)==null?void 0:e.event)==null||r.on("salla-products-slider::products.fetched",i=>{t.contains(i.target)&&setTimeout(()=>{let s=t.querySelectorAll(".s-product-card-entry");if(!s.length)return;let o=0,n=15;s.forEach(a=>{a.classList.contains("s-product-card-out-of-stock")||o>=n?a.style.display="none":o++})},200)})}waitForElement(t,e){let r=document.querySelector(t);if(r){e(r);return}let i=new MutationObserver(()=>{let s=document.querySelector(t);s&&(i.disconnect(),e(s))});i.observe(document.body,{childList:!0,subtree:!0})}},$=new v,E=$;var f=!1,D=0,T=2;function y(){if(f||(D++,D>T))return;let c=document.querySelector('salla-products-list[source="product.index"], salla-products-list[source="categories"]');if(c){let e=c.getAttribute("source-value");if(e){N("category",e),f=!0;return}}let t=document.querySelector('salla-products-list[source="product.index.tag"], salla-products-list[source^="tags."]');if(t){let e=t.getAttribute("source-value");if(e){N("tag",e),f=!0;return}}D<T&&setTimeout(y,800)}function N(c,t){if(document.querySelector(`product-ranking[${c}-id="${t}"]`))return;let e=document.createElement("product-ranking");e.setAttribute(`${c}-id`,t),document.body.appendChild(e)}document.addEventListener("salla::page::changed",()=>{f=!1,D=0,document.querySelectorAll("product-ranking").forEach(c=>c.remove()),setTimeout(y,100)});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):(y(),document.addEventListener("salla::ready",()=>{f||setTimeout(y,100)}));window.productRecommendations=E;window.redisService=d;var M=c=>document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c();M(()=>{if((document.body.classList.contains("page-home")||window.location.pathname==="/"||window.location.pathname==="")&&!document.querySelector("mahaba-category-products")){let e=document.querySelector(".s-home-content");if(e){let r=document.createElement("mahaba-category-products");e.appendChild(r),console.log("\u2705 [Algolia Bundle] Homepage category component injected")}}document.querySelector('[id^="product-"]')&&setTimeout(()=>{E.initialize(),console.log("\u2705 [Algolia Bundle] Product recommendations initialized")},3e3),console.log("\u2705 [Algolia Bundle] Loaded successfully")});})();
